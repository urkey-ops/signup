<script>
    // ... existing variables (API_URL, adminToken, DEFAULT_SLOT_LABELS, renderCheckboxes, showMessage, login, submitNewSlots) ...
    
    // --- NEW: Global array to store the row IDs of selected slots for deletion ---
    let slotsToDelete = [];

    // --- NEW: Function to handle checkbox selection ---
    function toggleSlotSelection(rowId, isChecked) {
        if (isChecked) {
            if (!slotsToDelete.includes(rowId)) {
                slotsToDelete.push(rowId);
            }
        } else {
            slotsToDelete = slotsToDelete.filter(id => id !== rowId);
        }
        updateDeleteButton();
    }

    // --- NEW: Function to update the Delete button text and visibility ---
    function updateDeleteButton() {
        const deleteBtn = document.getElementById('deleteSelectedBtn');
        const count = slotsToDelete.length;
        if (count > 0) {
            deleteBtn.textContent = `Delete Selected Slots (${count})`;
            deleteBtn.style.display = 'inline-block';
        } else {
            deleteBtn.style.display = 'none';
        }
    }


    async function loadSlots() {
        document.getElementById("slotsDisplay").innerHTML = "<p>Loading slots...</p>";
        slotsToDelete = []; // Reset selection on load
        updateDeleteButton(); // Hide button

        try {
            const res = await fetch(API_URL, {
                headers: { "Authorization": `Bearer ${adminToken}` }
            });
            const data = await res.json();
            
            if (!data.ok) {
                document.getElementById("slotsDisplay").innerHTML = "<p class='msg-box error'>Failed to load slots</p>";
                return;
            }

            // Group by date
            const grouped = {};
            // --- NEW: Collect all existing dates for Q2 validation ---
            const existingDates = new Set(); 

            data.slots.forEach(slot => {
                if (!grouped[slot.date]) grouped[slot.date] = [];
                grouped[slot.date].push(slot);
                existingDates.add(slot.date);
            });
            
            // --- Q2 Implementation: Set max date for calendar ---
            setCalendarMinDate(); 
            // --- Q2 Implementation: Highlight existing dates ---
            updateCalendarExistingDates(existingDates);

            let html = "";
            if (Object.keys(grouped).length === 0) {
                html = "<p>No slots added yet.</p>";
            } else {
                html += '<div style="text-align: right; margin-bottom: 10px;">';
                html += '<button id="deleteSelectedBtn" onclick="deleteSelectedSlots()" class="btn-delete" style="display: none;">Delete Selected Slots</button></div>';

                // Sort and render dates
                Object.keys(grouped).sort().forEach(date => {
                    html += `
                        <div class="date-group">
                            <h3>${date}</h3>
                            <div class="responsive-table-wrap">
                                <table class="slots-table">
                                    <thead>
                                        <tr>
                                            <th>Select</th> <th>Time Slot</th>
                                            <th>Capacity</th>
                                            <th>Taken</th>
                                            <th>Available</th>
                                            </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    grouped[date].forEach(slot => {
                        html += `
                            <tr>
                                <td>
                                    <input type="checkbox" onchange="toggleSlotSelection(${slot.id}, this.checked)">
                                </td>
                                <td>${slot.slotLabel}</td>
                                <td>${slot.capacity}</td>
                                <td>${slot.taken}</td>
                                <td class="${slot.available <= 0 ? 'full-slot' : ''}">${slot.available}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById("slotsDisplay").innerHTML = html;
            updateDeleteButton(); // Ensure button state is correct after rendering
        } catch (err) {
            document.getElementById("slotsDisplay").innerHTML = "<p class='msg-box error'>Error loading slots</p>";
        }
    }

    // --- NEW: Multi-Delete Functionality (Replaces deleteSlot) ---
    async function deleteSelectedSlots() {
        if (slotsToDelete.length === 0) {
            alert("Please select at least one slot to delete.");
            return;
        }

        if (!confirm(`Are you sure you want to delete ${slotsToDelete.length} slot(s)? This cannot be undone.`)) return;
        
        document.getElementById("slotsDisplay").innerHTML = "<p>Deleting selected slots...</p>";

        try {
            const res = await fetch(API_URL, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${adminToken}`
                },
                // Send an array of row IDs
                body: JSON.stringify({ rowIds: slotsToDelete }) 
            });
            
            const data = await res.json();
            if (data.ok) {
                document.getElementById("slotsDisplay").innerHTML = `<p class="msg-box success">${data.message}</p>`;
                setTimeout(loadSlots, 1000); 
            } else {
                alert("Failed to delete: " + data.error);
                loadSlots();
            }
        } catch (err) {
            alert("Failed to delete slots");
            loadSlots();
        }
    }
    
    // Original deleteSlot is removed / renamed to deleteSelectedSlots
    // The previous implementation of deleteSlot(rowId) is replaced entirely.
    
    // --- Q2 Implementation: Set minimum date to today ---
    function setCalendarMinDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("newDate").setAttribute('min', today);
    }

    // --- Q2 Implementation: Prevent re-adding a date already in the sheet ---
    let existingDateSet = new Set();
    
    function updateCalendarExistingDates(dates) {
        // dates is a Set of MM/DD/YYYY strings
        existingDateSet = dates;
    }

    // Update submitNewSlots validation
    async function submitNewSlots() {
        const dateInput = document.getElementById("newDate").value;    
        
        if (!dateInput) {
            showMessage("addMsg", "Please select a date.", true);
            return;
        }
        
        // Converts YYYY-MM-DD to MM/DD/YYYY for backend/comparison
        const [year, month, day] = dateInput.split('-');
        const dateMMDDYYYY = `${month.padStart(2, '0')}/${day.padStart(2, '0')}/${year}`; 

        // --- NEW: Q2 Validation Check ---
        if (existingDateSet.has(dateMMDDYYYY)) {
            showMessage("addMsg", `Slots for ${dateMMDDYYYY} already exist. Please choose a different date or delete the existing slots.`, true);
            return;
        }
        
        // The rest of the original logic proceeds...
        const date = dateMMDDYYYY;
        const checkboxes = document.querySelectorAll(".slot-checkbox");
        // ... (rest of the submitNewSlots function remains the same)
        
        // ... (rest of the submitNewSlots logic) ...
    }
    
    // document.addEventListener('DOMContentLoaded', () => { renderCheckboxes(); setCalendarMinDate(); });
    // This DOMContentLoaded call is implicitly handled by the loadSlots() call in login()

</script>
