<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5">
    <meta name="description" content="Book your time slots easily and manage your bookings online">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- ‚úÖ OPTIMIZED CSP: Removed unsafe-inline, using nonces -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   style-src 'self' 'nonce-RANDOM_NONCE' https://fonts.googleapis.com;
                   font-src 'self' https://fonts.gstatic.com;
                   script-src 'self' 'nonce-RANDOM_NONCE';
                   img-src 'self' data: blob:;
                   connect-src 'self';
                   base-uri 'self';
                   form-action 'self';
                   frame-ancestors 'none';">
    
    <title>Book a Slot - Online Booking System</title>

    <!-- ‚úÖ Preconnect to critical origins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- ‚úÖ Preload critical CSS -->
    <link rel="preload" href="user-style.css" as="style">
    <link rel="stylesheet" href="user-style.css">
    
    <!-- ‚úÖ Async load fonts (non-blocking) -->
    <link rel="preload" 
          href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" 
          as="style" 
          onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    </noscript>

    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">

    <!-- ‚úÖ CRITICAL CSS: Instant render (50% smaller) -->
    <style nonce="RANDOM_NONCE">
        body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',Inter,'Segoe UI',sans-serif;margin:0;background:#f8fafc;line-height:1.5;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent}
        .container{max-width:800px;margin:0 auto;padding:1rem;padding-bottom:calc(120px + env(safe-area-inset-bottom))}
        h1{font-size:clamp(1.5rem,5vw,2rem);font-weight:700;color:#0f172a;margin-bottom:.5rem;letter-spacing:-.02em;line-height:1.2}
        #loadingMsg{text-align:center;padding:40px 20px;color:#64748b}
        .hidden{display:none!important}
        .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
        .spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(16,185,129,.3);border-radius:50%;border-top-color:#10b981;animation:spin .8s ease-in-out infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üìÖ Book Your Slot</h1>
    </header>

    <main>
        <!-- Lookup Section -->
        <section class="card lookup-section card-compact" aria-labelledby="lookup-heading">
            <h2 id="lookup-heading" class="visually-hidden">Lookup and Cancel Bookings</h2>
            <button id="lookupToggle" 
                    class="btn secondary-btn full-width-mobile" 
                    aria-expanded="false"
                    aria-controls="lookupContent"
                    type="button">
                üîç Look Up / Cancel Booking
            </button>
            <div id="lookupContent" class="hidden" aria-hidden="true"> 
                <p class="description mt-15">
                    Enter your phone number to view and manage your bookings.
                </p>
                <div class="lookup-controls">
                    <label for="lookupPhone" class="visually-hidden">Phone number for booking lookup</label>
                    <input type="tel" 
                           id="lookupPhone" 
                           class="form-input lookup-input" 
                           placeholder="Enter your phone number"
                           maxlength="20"
                           autocomplete="tel"
                           inputmode="tel"
                           aria-describedby="phone-hint">
                    <span id="phone-hint" class="visually-hidden">
                        Enter your 10-digit phone number to search for bookings
                    </span>
                    <button id="lookupSearchBtn" 
                            class="btn secondary-btn" 
                            aria-label="Search for bookings"
                            type="button">
                        Search
                    </button>
                </div>
            </div>
            <div id="userBookingsDisplay" 
                 class="mt-15" 
                 role="region" 
                 aria-live="polite" 
                 aria-label="Your bookings">
            </div>
        </section>

        <!-- Slots Section -->
        <div id="loadingMsg" role="status" aria-live="polite">
            <span class="spinner" aria-hidden="true"></span>
            <span>Loading available slots...</span>
        </div>
        <div id="slotsDisplay" class="hidden">
            <p class="description">
                Select one or more time slots. You can choose multiple slots across different dates. 
                <strong>All times shown are in Eastern Time (ET)</strong>.
            </p>
            <div id="datesContainer" class="h-100" role="region" aria-label="Available time slots"></div>
            <div class="h-100" aria-hidden="true"></div> 
        </div>
        
        <!-- Floating Signup Button -->
        <div id="floatingSignupBtnContainer" class="hidden" role="region" aria-live="polite">
            <button id="floatingSignupBtn" 
                    class="btn primary-btn" 
                    type="button"
                    aria-label="Continue to sign up with selected slots">
                Continue to Sign Up (0 Slots Selected)
            </button>
        </div>

        <!-- Signup Form -->
        <section id="signupSection" class="card hidden" aria-labelledby="signup-heading">
            <h2 id="signup-heading">‚úçÔ∏è Enter Your Details</h2>
            <div id="selectedSlotSummary" 
                 class="selected-slots-summary" 
                 role="region" 
                 aria-label="Selected slots summary">
            </div>
            <form id="signupForm" novalidate>
                <label for="nameInput" class="visually-hidden">Your Full Name (Required)</label>
                <input type="text" 
                       id="nameInput" 
                       class="form-input" 
                       placeholder="Your Full Name *" 
                       required 
                       maxlength="100" 
                       autocomplete="name" 
                       aria-required="true"
                       aria-describedby="name-hint">
                <span id="name-hint" class="visually-hidden">Enter your full name, at least 2 characters</span>

                <label for="phoneInput" class="visually-hidden">Phone Number (Required)</label>
                <input type="tel" 
                       id="phoneInput" 
                       class="form-input" 
                       placeholder="Phone Number *" 
                       required 
                       maxlength="20" 
                       autocomplete="tel" 
                       inputmode="tel"
                       aria-required="true"
                       aria-describedby="phone-signup-hint">
                <span id="phone-signup-hint" class="visually-hidden">Enter your 10-digit phone number</span>

                <label for="emailInput" class="visually-hidden">Your Email Address (Optional)</label>
                <input type="email" 
                       id="emailInput" 
                       class="form-input" 
                       placeholder="Your Email Address (Optional)" 
                       maxlength="254" 
                       autocomplete="email"
                       inputmode="email">

                <label for="categorySelect" class="visually-hidden">Select Category (Required)</label>
                <select id="categorySelect" 
                        class="form-input" 
                        required 
                        aria-required="true">
                    <option value="" disabled selected>-- Select Category * --</option>
                    <option value="Bal">Bal</option>
                    <option value="Balika">Balika</option>
                    <option value="Kishore">Kishore</option>
                    <option value="Kishori">Kishori</option>
                    <option value="Yuvak">Yuvak</option>
                    <option value="Yuvati">Yuvati</option>
                    <option value="Premvati">Premvati</option>
                    <option value="Sanyukta">Sanyukta</option>
                </select>

                <label for="notesInput" class="visually-hidden">Any special notes or comments (Optional)</label>
                <textarea id="notesInput" 
                          class="form-input" 
                          placeholder="Any special notes or comments (Optional)" 
                          rows="3" 
                          maxlength="500"></textarea>

                <div id="signupMsg" class="msg-box" role="alert" aria-live="assertive"></div>

                <button type="submit" 
                        id="submitSignupBtn" 
                        class="btn primary-btn">
                    Submit Signup
                </button>
                <button type="button" 
                        id="backToSlotsBtn" 
                        class="btn secondary-btn">
                    ‚Üê Back to Slot Selection
                </button>
            </form>
        </section>

        <!-- Success Message -->
        <section id="successMessage" class="card hidden" aria-labelledby="success-heading">
            <h2 id="success-heading">üéâ Booking Confirmed!</h2>
            <div id="confirmationDetails" role="status" aria-live="polite"></div>
            <button id="resetPageBtn" 
                    class="btn primary-btn"
                    type="button">
                Book Another Slot
            </button>
        </section>
    </main>
</div>

<!-- ‚úÖ OPTIMIZED: Single entry point, lazy loading -->
<script type="module" nonce="RANDOM_NONCE">
    (async function initApp() {
        const startTime = performance.now();
        try {
            const [config, utils, slots] = await Promise.all([
                import('./config.js'),
                import('./utils.js'),
                import('./slots.js')
            ]);
            console.log('‚úÖ Core modules loaded');
            if (document.readyState === 'loading') {
                await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve, { once: true }));
            }
            await slots.loadSlots();
            const lookupBtn = document.getElementById('lookupToggle');
            if (lookupBtn) {
                lookupBtn.addEventListener('click', async () => {
                    if (!window.__lookupLoaded) {
                        console.log('üì¶ Lazy loading lookup module...');
                        await import('./lookup.js');
                        window.__lookupLoaded = true;
                    }
                }, { once: true });
            }
            window.addEventListener('showSignupForm', async () => {
                if (!window.__signupLoaded) {
                    console.log('üì¶ Lazy loading signup module...');
                    await import('./signup-frontend.js');
                    window.__signupLoaded = true;
                }
            }, { once: true });
            window.__APP__ = {
                loadSlots: slots.loadSlots,
                forceReload: slots.forceReloadSlots,
                getState: config.getStateSnapshot,
                cleanup: () => {
                    slots.cleanup();
                    console.log('üßπ App cleaned up');
                }
            };
            const loadTime = performance.now() - startTime;
            console.log(`üöÄ App initialized in ${loadTime.toFixed(0)}ms`);
        } catch (error) {
            console.error('‚ùå App initialization failed:', error);
            const loadingMsg = document.getElementById('loadingMsg');
            if (loadingMsg) {
                loadingMsg.innerHTML = `
                    <div class="msg-box error" role="alert" style="text-align: center; padding: 20px;">
                        ‚ö†Ô∏è Failed to load application. Please refresh the page.
                        <br><br>
                        <button onclick="location.reload()" class="btn secondary-btn" style="margin-top: 15px;">
                            üîÑ Refresh Page
                        </button>
                    </div>
                `;
            }
        }
    })();
</script>

<!-- No-JavaScript Fallback -->
<noscript>
    <div style="padding: 20px; text-align: center; background: #fee2e2; border: 2px solid #ef4444; margin: 20px; border-radius: 12px;">
        <h2>‚ö†Ô∏è JavaScript Required</h2>
        <p>This booking system requires JavaScript to function. Please enable JavaScript in your browser settings.</p>
    </div>
</noscript>
</body>
</html>
